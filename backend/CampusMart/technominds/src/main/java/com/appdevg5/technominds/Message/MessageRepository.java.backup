package com.appdevg5.technominds.Message;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;

/**
 * Repository interface for Message entity.
 */
@Repository
public interface MessageRepository extends JpaRepository<MessageEntity, Integer> {

    /**
     * Finds all messages sent by a specific sender.
     * Uses nested property path to match MessageEntity.sender.id
     */
    List<MessageEntity> findBySender_Id(Integer senderId);

    /**
     * Finds all messages received by a specific receiver.
     * Uses nested property path to match MessageEntity.receiver.id
     */
    List<MessageEntity> findByReceiver_Id(Integer receiverId);

    /**
     * Finds the conversation history between two specific users in chronological order.
     * Uses nested property path and the createdAt timestamp.
     */
    List<MessageEntity> findBySender_IdAndReceiver_IdOrderByCreatedAtAsc(Integer senderId, Integer receiverId);

    /**
     * Finds messages between two users for a specific product.
     */
    List<MessageEntity> findBySender_IdAndReceiver_IdAndProduct_IdOrderByCreatedAtAsc(
        Integer senderId, Integer receiverId, Integer productId);

    /**
     * Count unread messages for a specific user.
     */
    Long countByReceiver_IdAndIsRead(Integer receiverId, Boolean isRead);

    /**
     * Find all messages where user is either sender or receiver, ordered by most recent.
     */
    @Query("SELECT m FROM MessageEntity m WHERE m.sender.id = :userId OR m.receiver.id = :userId ORDER BY m.createdAt DESC")
    List<MessageEntity> findAllUserMessages(@Param("userId") Integer userId);

    /**
     * Find unread messages for a receiver.
     */
    List<MessageEntity> findByReceiver_IdAndIsReadOrderByCreatedAtDesc(Integer receiverId, Boolean isRead);
}